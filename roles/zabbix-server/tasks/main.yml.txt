---
- name: Download Zabbix release package using wget
  ansible.builtin.shell: |
    wget -O /tmp/zabbix-release.deb \
    "https://repo.zabbix.com/zabbix/{{ zabbix_version }}/release/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_{{ zabbix_version }}+ubuntu24.04_all.deb"
  args:
    executable: /bin/bash

- name: Install Zabbix release package
  ansible.builtin.apt:
    deb: /tmp/zabbix-release.deb

- name: Update apt cache again
  ansible.builtin.apt:
    update_cache: yes

- name: Install Zabbix server, frontend, agent2 and plugins
  ansible.builtin.apt:
    name:
      - zabbix-server-mysql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-sql-scripts
    state: present

- name: Create initial Zabbix database
  ansible.builtin.shell: |
    mysql -uroot -p{{ db_root_password }} -e "CREATE DATABASE zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
    mysql -uroot -p{{ db_root_password }} -e "CREATE USER 'zabbix'@'%' IDENTIFIED BY '{{ db_zabbix_password }}';"
    mysql -uroot -p{{ db_root_password }} -e "GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'%';"
    mysql -uroot -p{{ db_root_password }} -e "SET GLOBAL log_bin_trust_function_creators = 1;"
  args:
    executable: /bin/bash

- name: Import initial schema and data
  ansible.builtin.shell: |
    zcat /usr/share/zabbix/sql-scripts/mysql/server.sql.gz \
    | mysql --default-character-set=utf8mb4 -uzabbix -p{{ db_zabbix_password }} zabbix
  args:
    executable: /bin/bash

- name: Disable log_bin_trust_function_creators option
  ansible.builtin.shell: |
    mysql -uroot -p{{ db_root_password }} -e "SET GLOBAL log_bin_trust_function_creators = 0;"
  args:
    executable: /bin/bash

- name: Configure Zabbix Server DB password
  ansible.builtin.template:
    src: zabbix_server.conf.j2
    dest: /etc/zabbix/zabbix_server.conf
    owner: root
    group: root
    mode: '0644'

- name: Start and enable Zabbix Server
  ansible.builtin.systemd:
    name: zabbix-server
    enabled: yes
    state: restarted
