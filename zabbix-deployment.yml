---
- name: Install and configure Zabbix Server 7.2 with MySQL on Ubuntu 24.04
  hosts: zabbix-server
  become: yes
  vars_files:
    - vault.yml   # Load encrypted passwords from vault
 
  vars:
    zabbix_version: "7.2"
 
  tasks:
 
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
 
    - name: Install MySQL Server
      ansible.builtin.apt:
        name: mysql-server
        state: present
 
    - name: Download Zabbix release package using wget
      ansible.builtin.shell: |
        wget -O /tmp/zabbix-release.deb "https://repo.zabbix.com/zabbix/{{ zabbix_version }}/release/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_{{ zabbix_version }}+ubuntu24.04_all.deb"
      args:
        executable: /bin/bash
 
    - name: Install Zabbix release package
      ansible.builtin.apt:
        deb: /tmp/zabbix-release.deb
 
    - name: Update apt cache again
      ansible.builtin.apt:
        update_cache: yes
 
    - name: Install Zabbix server, frontend, agent2 and plugins
      ansible.builtin.apt:
        name:
          - zabbix-server-mysql
          - zabbix-frontend-php
          - zabbix-apache-conf
          - zabbix-sql-scripts
          - zabbix-agent2
          - zabbix-agent2-plugin-mongodb
          - zabbix-agent2-plugin-mssql
          - zabbix-agent2-plugin-postgresql
        state: present
 
    - name: Create initial Zabbix database
      ansible.builtin.shell: |
        mysql -uroot -p{{ db_root_password }} -e "CREATE DATABASE zabbix CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;"
        mysql -uroot -p{{ db_root_password }} -e "CREATE USER 'zabbix'@'%' IDENTIFIED BY '{{ db_zabbix_password }}';"
        mysql -uroot -p{{ db_root_password }} -e "GRANT ALL PRIVILEGES ON zabbix.* TO 'zabbix'@'%';"
        mysql -uroot -p{{ db_root_password }} -e "SET GLOBAL log_bin_trust_function_creators = 1;"
      args:
        executable: /bin/bash
 
    - name: Import initial schema and data
      ansible.builtin.shell: |
        zcat /usr/share/zabbix/sql-scripts/mysql/server.sql.gz | mysql --default-character-set=utf8mb4 -uzabbix -p{{ db_zabbix_password }} zabbix
      args:
        executable: /bin/bash
 
    - name: Disable log_bin_trust_function_creators option
      ansible.builtin.shell: |
        mysql -uroot -p{{ db_root_password }} -e "SET GLOBAL log_bin_trust_function_creators = 0;"
      args:
        executable: /bin/bash
 
    - name: Configure Zabbix Server DB password
      ansible.builtin.lineinfile:
        path: /etc/zabbix/zabbix_server.conf
        regexp: '^#?DBPassword='
        line: "DBPassword={{ db_zabbix_password }}"
 
    - name: Start and enable Zabbix and related services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: yes
        state: restarted
      loop:
        - zabbix-server
        - zabbix-agent2
        - apache2
